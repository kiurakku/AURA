# Виправлення помилки 409 Conflict в Telegram боті

## Проблема
Помилка `409 Conflict: terminated by other getUpdates request` виникає, коли кілька екземплярів бота намагаються отримувати оновлення через polling одночасно.

## Причина
Під час деплою на Fly.io нова машина може запуститися до того, як стара зупиниться, що призводить до тимчасового конфлікту двох екземплярів бота.

## Виконані зміни

### 1. Обробка помилок polling (backend/bot/bot.js)
Додано обробник помилок, який ігнорує 409 конфлікти під час деплою:
```javascript
bot.on('polling_error', (error) => {
  // Ignore 409 conflicts during deployments
  if (error.code === 'ETELEGRAM' && error.response?.body?.error_code === 409) {
    return; // Silently ignore
  }
  console.error('❌ Polling error:', error.message);
});
```

### 2. Обмеження кількості машин (fly.toml)
Додано `max_machines_running = 1` для гарантії, що завжди працює лише одна машина:
```toml
min_machines_running = 1
max_machines_running = 1
```

### 3. Налаштування polling
Оптимізовано параметри polling для кращої стабільності:
```javascript
polling: {
  interval: 300,
  autoStart: true,
  params: {
    timeout: 10
  }
}
```

## Результат

Після цих змін:
- ✅ 409 конфлікти ігноруються під час деплою
- ✅ Бот продовжує працювати навіть під час деплою
- ✅ Інші помилки polling все ще логуються для діагностики
- ✅ Гарантована лише одна активна машина

## Перевірка

Після деплою перевірте логи:
```bash
fly logs --app auraslots
```

Ви повинні побачити:
- ✅ Менше помилок 409 (вони все ще можуть з'являтися під час деплою, але тепер ігноруються)
- ✅ Бот успішно працює після деплою
- ✅ Команди бота працюють коректно

## Додаткові рекомендації

Якщо проблема залишається:

1. **Перевірте кількість машин:**
```bash
fly status --app auraslots
```

2. **Переконайтеся, що запущена лише одна машина:**
```bash
fly scale count 1 --app auraslots
```

3. **Перевірте, чи немає інших екземплярів бота:**
   - Переконайтеся, що бот не запущений локально
   - Переконайтеся, що немає інших серверів з цим ботом

4. **Розгляньте використання webhook замість polling:**
   - Webhook більш стабільний для production
   - Але потребує додаткового налаштування

## Примітка

409 конфлікти під час деплою - це нормально і очікувано. Тепер вони ігноруються, і бот продовжує працювати без перешкод.
